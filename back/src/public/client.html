<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WS Test Client (with JWT)</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f5f5f5;
            color: #222;
            padding: 12px
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px
        }

        input[type=text] {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px
        }

        button {
            padding: 6px 10px;
            border: 1px solid #999;
            background: #eee;
            border-radius: 4px;
            cursor: pointer
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed
        }

        #canvas {
            background: #fff;
            border: 1px solid #ccc;
            cursor: crosshair
        }

        #log {
            height: 220px;
            overflow: auto;
            background: #111;
            color: #eee;
            padding: 8px;
            font-size: 12px;
            border-radius: 4px
        }

        #players {
            background: #fff;
            padding: 8px;
            border: 1px solid #ccc;
            min-height: 80px
        }

        .small {
            font-size: 13px;
            color: #555
        }
    </style>
</head>

<body>
    <h2>WebSocket Test Client (with JWT)</h2>

    <div class="row">
        <label class="small">WS URL</label>
        <input id="url" type="text" value="wss://dr-mundo.onrender.com" style="width:260px" />
        <label class="small">JWT</label>
        <input id="jwt" type="text" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6OSwiZW1haWwiOiJzMjQ0M0BlLW1pcmltLmhzLmtyIiwibmlja05hbWUiOiLrr7zsoJXsm5AiLCJpYXQiOjE3NjI3ODY0ODcsImV4cCI6MTc2Mjc5MDA4N30.6TY__vy1p7ZhItBJw-hflXG644RvEtA8jo_BrdKkqNk" style="flex:1" />
        <label class="small">Room</label>
        <input id="room" type="text" value="1" style="width:60px" />
        <button id="connect">Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
    </div>

    <div class="row">
        <button id="join" disabled>Join Room</button>
        <button id="leave" disabled>Leave Room</button>
        <button id="start" disabled>Start Game</button>
        <span id="status" class="small">상태: disconnected</span>
        <span style="margin-left:12px" class="small">PlayerId: <strong id="playerId">-</strong></span>
    </div>

    <div class="row">
        <canvas id="canvas" width="640" height="360"></canvas>
        <div style="width:260px">
            <div style="margin-bottom:8px">
                <button id="btnAttack" disabled>Attack (Q)</button>
                <button id="btnGhost" disabled>Ghost (D)</button>
                <button id="btnFlash" disabled>Flash (F)</button>
            </div>
            <div style="margin-bottom:8px">
                <div class="small">Players</div>
                <div id="players"></div>
            </div>
            <div>
                <div class="small">Raw send (JSON)</div>
                <input id="raw" type="text" placeholder='{"event":"ping"}' style="width:100%;box-sizing:border-box" />
                <div style="margin-top:6px"><button id="sendRaw" disabled>Send</button></div>
            </div>
        </div>
    </div>

    <h4>Logs</h4>
    <div id="log"></div>

    <script>
        (() => {
            const urlInput = document.getElementById('url');
            const roomInput = document.getElementById('room');
            const jwtInput = document.getElementById('jwt'); // JWT 입력 필드 참조 추가
            const connectBtn = document.getElementById('connect');
            const disconnectBtn = document.getElementById('disconnect');
            const joinBtn = document.getElementById('join');
            const leaveBtn = document.getElementById('leave');
            const startBtn = document.getElementById('start');
            const statusSpan = document.getElementById('status');
            const playerIdEl = document.getElementById('playerId');
            const logEl = document.getElementById('log');
            const playersEl = document.getElementById('players');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const btnAttack = document.getElementById('btnAttack');
            const btnGhost = document.getElementById('btnGhost');
            const btnFlash = document.getElementById('btnFlash');
            const rawInput = document.getElementById('raw');
            const sendRawBtn = document.getElementById('sendRaw');

            let ws = null;
            let myPlayerId = null;
            let roomId = null;
            let players = new Map();
            let currentSkill = null;
            let gameStarted = false;

            function log(msg, type = 'info') {
                const time = new Date().toLocaleTimeString();
                const item = document.createElement('div');
                item.textContent = `[${time}] ${msg}`;
                if (type === 'error') item.style.color = 'salmon';
                logEl.prepend(item);
            }

            function setStatus(s) {
                statusSpan.textContent = '상태: ' + s;
            }

            function enableUIOnConnect() {
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                joinBtn.disabled = false;
                sendRawBtn.disabled = false;
            }

            function disableUIOnDisconnect() {
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                joinBtn.disabled = true;
                leaveBtn.disabled = true;
                startBtn.disabled = true;
                btnAttack.disabled = true;
                btnGhost.disabled = true;
                btnFlash.disabled = true;
                sendRawBtn.disabled = true;
                playerIdEl.textContent = '-';
            }

            function drawPlayers() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // simple grid
                ctx.strokeStyle = '#eee';
                ctx.lineWidth = 0.3;
                for (let i = 0; i < canvas.width; i += 40) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke(); }
                for (let j = 0; j < canvas.height; j += 40) { ctx.beginPath(); ctx.moveTo(0, j); ctx.lineTo(canvas.width, j); ctx.stroke(); }

                players.forEach(p => {
                    ctx.fillStyle = (p.playerId === myPlayerId) ? '#2b8' : '#d33';
                    ctx.beginPath();
                    ctx.arc(p.x || 400, p.y || 200, 12, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#000';
                    ctx.font = '11px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(p.playerId === myPlayerId ? 'YOU' : (p.playerId || '').slice(-6), p.x || 400, (p.y || 200) - 18);
                });
            }

            function updatePlayersListUI() {
                playersEl.innerHTML = '';
                players.forEach(p => {
                    const div = document.createElement('div');
                    div.textContent = `${p.playerId} — HP:${Math.round(p.hp || 0)} — (${Math.round(p.x || 0)},${Math.round(p.y || 0)})`;
                    playersEl.appendChild(div);
                });
            }

            connectBtn.addEventListener('click', () => {
                let url = urlInput.value.trim();
                const jwt = jwtInput.value.trim(); // JWT 값 가져오기
                
                if (!url) return alert('URL을 입력하세요.');

                // JWT를 쿼리 파라미터로 추가 (예: wss://server.com?token=...)
                if (jwt && jwt !== 'YOUR_JWT_HERE') {
                    const separator = url.includes('?') ? '&' : '?';
                    url = `${url}${separator}token=${jwt}`;
                    log('JWT를 URL에 추가했습니다.');
                }

                try {
                    ws = new WebSocket(url); // JWT가 포함된 URL로 연결 시도
                } catch (e) {
                    log('WebSocket 생성 실패: ' + e.message, 'error');
                    return;
                }
                setStatus('connecting...');
                log('Connecting to ' + url);
                
                ws.onopen = () => {
                    setStatus('connected');
                    enableUIOnConnect();
                    log('연결 성공', 'info');
                };
                
                ws.onmessage = (ev) => {
                    try {
                        const data = JSON.parse(ev.data);
                        handleMessage(data);
                    } catch (e) {
                        log('수신 메시지 파싱 실패: ' + ev.data, 'error');
                    }
                };

                ws.onclose = () => {
                    setStatus('disconnected');
                    disableUIOnDisconnect();
                    log('연결 종료', 'error');
                    players.clear();
                    updatePlayersListUI();
                    drawPlayers();
                    ws = null;
                    gameStarted = false;
                };

                ws.onerror = (err) => {
                    log('WebSocket 오류', 'error');
                    console.error(err);
                };
            });

            disconnectBtn.addEventListener('click', () => {
                if (ws) ws.close();
            });

            joinBtn.addEventListener('click', () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                roomId = parseInt(roomInput.value) || 1;
                ws.send(JSON.stringify({ event: 'join', roomId }));
                log('join 요청 보냄: room=' + roomId);
            });

            leaveBtn.addEventListener('click', () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                ws.send(JSON.stringify({ event: 'leave', roomId }));
                log('leave 요청 보냄');
            });

            startBtn.addEventListener('click', () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                ws.send(JSON.stringify({ event: 'start', roomId }));
                log('start 요청 보냄');
            });

            btnAttack.addEventListener('click', () => { currentSkill = 'attack'; log('Attack 모드: 캔버스 클릭으로 목표 지정'); });
            btnFlash.addEventListener('click', () => { currentSkill = 'flash'; log('Flash 모드: 캔버스 클릭으로 목적지 지정'); });
            btnGhost.addEventListener('click', () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                ws.send(JSON.stringify({ event: 'ghost', speed: 340 }));
                log('ghost 요청 보냄');
            });

            sendRawBtn.addEventListener('click', () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                const raw = rawInput.value.trim();
                if (!raw) return;
                try {
                    const obj = JSON.parse(raw);
                    ws.send(JSON.stringify(obj));
                    log('Raw 전송: ' + JSON.stringify(obj));
                } catch (e) {
                    alert('유효한 JSON 으로 입력하세요.');
                }
            });

            canvas.addEventListener('click', (e) => {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                const rect = canvas.getBoundingClientRect();
                const x = Math.round(e.clientX - rect.left);
                const y = Math.round(e.clientY - rect.top);

                if (currentSkill === 'attack') {
                    ws.send(JSON.stringify({ event: 'attack', x, y, damage: 80 }));
                    log(`attack 전송 -> x:${x}, y:${y}`);
                    currentSkill = null;
                } else if (currentSkill === 'flash') {
                    ws.send(JSON.stringify({ event: 'flash', x, y }));
                    log(`flash 전송 -> x:${x}, y:${y}`);
                    currentSkill = null;
                } else {
                    // 일반 이동
                    ws.send(JSON.stringify({ event: 'move', x, y }));
                    log(`move 전송 -> x:${x}, y:${y}`);
                    // 로컬 예측(즉시 위치 반영)
                    const me = players.get(myPlayerId);
                    if (me) { me.x = x; me.y = y; updatePlayersListUI(); drawPlayers(); }
                }
            });

            // 수신 메시지 처리
            function handleMessage(data) {
                if (!data || typeof data !== 'object') return;
                switch (data.event) {
                    case 'connected':
                        myPlayerId = data.playerId;
                        playerIdEl.textContent = myPlayerId;
                        log('서버가 부여한 playerId: ' + myPlayerId);
                        break;
                    case 'joined':
                        if (data.success) {
                            log('방 참가 성공');
                            joinBtn.disabled = true;
                            leaveBtn.disabled = false;
                            startBtn.disabled = false;
                            // 내 초기 상태 추가
                            players.set(myPlayerId, { playerId: myPlayerId, x: 400, y: 200, hp: 705, maxHp: 705 });
                            updatePlayersListUI(); drawPlayers();
                        } else {
                            log('방 참가 실패', 'error');
                        }
                        break;
                    case 'playerJoined':
                        players.set(data.playerId, { playerId: data.playerId, x: data.x || 400, y: data.y || 200, hp: data.hp || 705, maxHp: data.maxHp || 705 });
                        log(`${data.playerId} 참가함`);
                        updatePlayersListUI(); drawPlayers();
                        break;
                    case 'playerLeft':
                        players.delete(data.playerId);
                        log(`${data.playerId} 퇴장`);
                        updatePlayersListUI(); drawPlayers();
                        break;
                    case 'gameStarted':
                        gameStarted = true;
                        btnAttack.disabled = false;
                        btnGhost.disabled = false;
                        btnFlash.disabled = false;
                        startBtn.disabled = true;
                        log('게임 시작');
                        break;
                    case 'playerMove':
                        {
                            // playerId, x, y
                            const p = players.get(data.playerId) || { playerId: data.playerId };
                            p.x = data.x; p.y = data.y;
                            players.set(data.playerId, p);
                            updatePlayersListUI(); drawPlayers();
                        }
                        break;
                    case 'attackCast':
                        log(`${data.playerId} 공격 시전`);
                        // 브로드캐스트를 통해 투사체를 시각화하거나 히트 이벤트를 기다리면 됨
                        break;
                    case 'hit':
                        log(`피격: x=${data.x}, y=${data.y}, hp=${data.hp}`, 'error');
                        // 서버가 보낸 hp를 토대로 내 hp 업데이트 (서버 주도)
                        if (myPlayerId) {
                            const me = players.get(myPlayerId);
                            if (me) { me.hp = data.hp; players.set(myPlayerId, me); updatePlayersListUI(); drawPlayers(); }
                        }
                        break;
                    case 'ghostActivated':
                        log(`${data.playerId} 유체화 활성화`);
                        break;
                    case 'playerFlashed':
                        {
                            const p = players.get(data.playerId) || { playerId: data.playerId };
                            p.x = data.x; p.y = data.y;
                            players.set(data.playerId, p);
                            log(`${data.playerId} 점멸`);
                            updatePlayersListUI(); drawPlayers();
                        }
                        break;
                    case 'coolTime':
                        // 쿨타임 정보를 받는다 (attack, ghost, flash)
                        log(`쿨타임: attack=${data.attack}s ghost=${data.ghost}s flash=${data.flash}s`);
                        break;
                    case 'finish':
                        log(`게임 종료. 승자: ${data.playerId}`, 'info');
                        gameStarted = false;
                        btnAttack.disabled = true; btnGhost.disabled = true; btnFlash.disabled = true;
                        break;
                    default:
                        // 기타 메시지 그대로 출력
                        log('수신: ' + JSON.stringify(data));
                }
            }

            // 초기 draw
            drawPlayers();

        })();
    </script>
</body>

</html>